<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Scale Driller</title>
  <meta name="description" content="Scale Driller – A number system quiz for bass players to practice scale degrees by key.">
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #f0f0f0;
      padding: 2rem;
      margin: 0;
    }
    select, input, button {
      padding: 0.5rem;
      font-size: 1rem;
      margin: 0.5rem;
    }
    #quizOverlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: white;
      z-index: 9999;
      padding: 2rem;
      box-sizing: border-box;
    }
    #closeQuizBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 1.5rem;
      background: none;
      border: none;
      cursor: pointer;
    }
    .choice {
      display: block;
      margin: 0.5rem auto;
      padding: 0.75rem;
      width: 200px;
      background: #ddd;
      border: none;
      cursor: pointer;
    }
    .correct {
      background-color: #90ee90 !important;
    }
    .disabled {
      background-color: #bbb;
      cursor: not-allowed;
    }
    #timer {
      font-weight: bold;
      font-size: 1.5rem;
    }
    #feedback {
      font-size: 1.2rem;
      font-weight: bold;
      margin-top: 1rem;
    }
  </style>
</head>
<body>

<h1>Scale Driller</h1>

<div id="setupContainer">
  <div>
    <label for="level">Select quiz level:</label>
    <select id="level" onchange="updateLevel()">
      <option value="easy">Easy</option>
      <option value="intermediate">Intermediate</option>
      <option value="hard">Hard</option>
    </select>
  </div>

  <div id="keyContainer">
    <label for="key">Select a key:</label>
    <select id="key">
      <option value="C">C</option>
      <option value="D">D</option>
      <option value="E">E</option>
      <option value="F">F</option>
      <option value="G">G</option>
      <option value="A">A</option>
      <option value="B">B</option>
      <option value="F#">F#</option>
      <option value="Ab">Ab</option>
      <option value="Bb">Bb</option>
      <option value="Db">Db</option>
      <option value="Eb">Eb</option>
    </select>
  </div>

  <div>
    <label for="secondsInput">Seconds per question:</label>
    <input type="number" id="secondsInput" min="1" value="10" style="width: 60px;">
  </div>

  <div>
    <label for="questionCountInput">Number of questions:</label>
    <input type="number" id="questionCountInput" min="1" value="5" style="width: 60px;">
  </div>

  <button onclick="startQuiz()">Start Quiz</button>

  <div>
    <button onclick="toggleChart()" id="toggleChartBtn">Hide Scale Chart</button>
  </div>

  <div id="scaleDisplay" style="margin-top: 1rem; display: inline-block; text-align: left;"></div>
</div>

<div id="quizOverlay">
  <button id="closeQuizBtn" onclick="closeQuiz()">&times;</button>
  <div id="quiz">
    <p id="question"></p>
    <p>⏱️ Time left: <span id="timer">10</span> seconds</p>
    <button onclick="showAnswer()" id="showAnswerBtn">Show Answer</button>
    <div id="choices"></div>
    <p id="feedback"></p>
  </div>
</div>

<div id="result" style="display: none;">
  <h2>Quiz Complete!</h2>
  <p>Your Score: <span id="score"></span></p>
  <button onclick="startQuiz()">Play Again</button>
</div>

<script>
const noteMap = {
  'C':  ['C', 'D', 'E', 'F', 'G', 'A', 'B'],
  'D':  ['D', 'E', 'F#', 'G', 'A', 'B', 'Db'],
  'E':  ['E', 'F#', 'Ab', 'A', 'B', 'Db', 'Eb'],
  'F':  ['F', 'G', 'A', 'Bb', 'C', 'D', 'E'],
  'G':  ['G', 'A', 'B', 'C', 'D', 'E', 'F#'],
  'A':  ['A', 'B', 'Db', 'D', 'E', 'F#', 'Ab'],
  'B':  ['B', 'Db', 'Eb', 'E', 'F#', 'Ab', 'Bb'],
  'F#': ['F#', 'Ab', 'Bb', 'B', 'Db', 'Eb', 'F'],
  'Ab': ['Ab', 'Bb', 'C', 'Db', 'Eb', 'F', 'G'],
  'Bb': ['Bb', 'C', 'D', 'Eb', 'F', 'G', 'A'],
  'Db': ['Db', 'Eb', 'F', 'F#', 'Ab', 'Bb', 'C'],
  'Eb': ['Eb', 'F', 'G', 'Ab', 'Bb', 'C', 'D'],
};

let score = 0;
let questionCount = 0;
let correctNote = '';
let timer;
let timeLeft = 10;
let secondsPerQuestion = 10;
let totalQuestions = 5;
let quizLevel = 'easy';
let currentKey = 'C';

document.getElementById('key').addEventListener('change', updateScaleDisplay);
document.getElementById('level').addEventListener('change', updateLevel);

function updateLevel() {
  quizLevel = document.getElementById('level').value;
  const keyContainer = document.getElementById('keyContainer');
  if (quizLevel === 'easy') {
    keyContainer.style.display = 'block';
    updateScaleDisplay();
  } else {
    keyContainer.style.display = 'none';
    document.getElementById('scaleDisplay').style.display = 'none';
    document.getElementById('toggleChartBtn').style.display = 'none';
  }
}

function startQuiz() {
  const inputVal = parseInt(document.getElementById('secondsInput').value);
  secondsPerQuestion = isNaN(inputVal) || inputVal < 1 ? 10 : inputVal;

  const questionInput = parseInt(document.getElementById('questionCountInput').value);
  totalQuestions = isNaN(questionInput) || questionInput < 1 ? 5 : questionInput;

  score = 0;
  questionCount = 0;
  document.getElementById('result').style.display = 'none';
  document.getElementById('quiz').style.display = 'block';
  document.getElementById('quizOverlay').style.display = 'block';
  document.getElementById('setupContainer').style.display = 'none';
  document.getElementById('feedback').textContent = '';
  document.getElementById('scaleDisplay').style.display = 'none';
  document.getElementById('toggleChartBtn').style.display = 'none';

  nextQuestion();
}

function nextQuestion() {
  if (questionCount >= totalQuestions) {
    endQuiz();
    return;
  }

  if (quizLevel === 'easy') {
    currentKey = document.getElementById('key').value;
  } else {
    const keys = Object.keys(noteMap);
    currentKey = keys[Math.floor(Math.random() * keys.length)];
  }

  const degrees = noteMap[currentKey];
  const correctIndex = Math.floor(Math.random() * 7);
  correctNote = degrees[correctIndex];
  const questionText = `What is the ${correctIndex + 1} in the key of ${currentKey}?`;

  document.getElementById('question').textContent = questionText;

  const choicesContainer = document.getElementById('choices');
  choicesContainer.innerHTML = '';
  document.getElementById('feedback').textContent = '';

  let options = [...degrees];
  shuffleArray(options);
  if (!options.includes(correctNote)) options[0] = correctNote;
  options = shuffleArray(options).slice(0, 4);
  if (!options.includes(correctNote)) options[Math.floor(Math.random() * 4)] = correctNote;

  options.forEach(option => {
    const btn = document.createElement('button');
    btn.textContent = option;
    btn.className = 'choice';
    btn.onclick = () => handleAnswer(option === correctNote, btn);
    choicesContainer.appendChild(btn);
  });

  timeLeft = secondsPerQuestion;
  document.getElementById('timer').textContent = timeLeft;
  clearInterval(timer);
  timer = setInterval(() => {
    timeLeft--;
    document.getElementById('timer').textContent = timeLeft;
    if (timeLeft <= 0) {
      clearInterval(timer);
      showAnswer(true);
    }
  }, 1000);

  document.getElementById('showAnswerBtn').disabled = false;
  questionCount++;
}

function showAnswer(timeout = false) {
  clearInterval(timer);
  const buttons = document.querySelectorAll('.choice');
  buttons.forEach(btn => {
    if (btn.textContent === correctNote) {
      btn.classList.add('correct');
    } else {
      btn.classList.add('disabled');
    }
    btn.disabled = true;
  });

  document.getElementById('showAnswerBtn').disabled = true;
  document.getElementById('feedback').textContent = timeout ? '⏰ Time\'s up!' : '✅ Answer shown';

  if (!timeout) score++;

  setTimeout(() => nextQuestion(), 1000);
}

function handleAnswer(isCorrect, button) {
  clearInterval(timer);
  const buttons = document.querySelectorAll('.choice');
  buttons.forEach(btn => {
    if (btn.textContent === correctNote) {
      btn.classList.add('correct');
    } else {
      btn.classList.add('disabled');
    }
    btn.disabled = true;
  });

  button.classList.add(isCorrect ? 'correct' : 'disabled');
  document.getElementById('showAnswerBtn').disabled = true;

  if (isCorrect) {
    document.getElementById('feedback').textContent = '✅ Correct!';
    score++;
  } else {
    document.getElementById('feedback').textContent = '❌ Incorrect.';
  }

  setTimeout(() => nextQuestion(), 1000);
}

function endQuiz() {
  document.getElementById('quiz').style.display = 'none';
  document.getElementById('result').style.display = 'block';
  document.getElementById('score').textContent = `${score} / ${totalQuestions}`;
}
function closeQuiz() {
  clearInterval(timer);
  document.getElementById('quizOverlay').style.display = 'none';
  document.getElementById('result').style.display = 'none';
  document.getElementById('setupContainer').style.display = 'block';
}
function toggleChart() {
  const chart = document.getElementById('scaleDisplay');
  const btn = document.getElementById('toggleChartBtn');
  const visible = chart.style.display !== 'none';
  chart.style.display = visible ? 'none' : 'inline-block';
  btn.textContent = visible ? 'Show Scale Chart' : 'Hide Scale Chart';
}

function updateScaleDisplay() {
  const key = document.getElementById('key').value;
  const scale = noteMap[key];
  const container = document.getElementById('scaleDisplay');

  container.style.display = 'inline-block';

  if (!scale) {
    container.innerHTML = '';
    return;
  }

  let html = `<div style="background: white; border-radius: 12px; padding: 1rem 1.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1); font-size: 1rem; max-width: 300px; margin: auto;">
    <h3 style="margin-top: 0;">Key of ${key}</h3>
    <table style="width: 100%; border-collapse: collapse;">
      <tr><th style="text-align: left;">Degree</th><th style="text-align: left;">Note</th></tr>`;
  scale.forEach((note, i) => {
    html += `<tr><td>${i + 1}</td><td>${note}</td></tr>`;
  });
  html += `</table></div>`;
  container.innerHTML = html;
}

function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}
</script>

</body>
</html>